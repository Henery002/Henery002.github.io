---
title: 微信小程序开发
date: 2019-04-17 12:01:05
tags:
---


本文将结合小程序示例项目源码，通过在手机微信客户端实时编译预览，交流学习小程序开发的流程、架构、语法与开放API等内容。

## 背景

> 小程序（Mini Program）是一种新的开放能力，是一种不需要下载安装即可使用的应用，它实现了应用“触手可及”的梦想，用户扫一扫或搜一下即可打开应用。

### 小程序发展史

2016年9月21日，微信小程序开启内测。腾讯云上线微信小程序解决方案，提供小程序在云端服务器的技术方案。

2017年1月9日，张小龙在2017微信公开课上宣布小程序正式上线。

2017年3月，小程序面向个人开发者开放注册。

2017年12月28日，微信小游戏上线 -- 全民娱乐的微信《跳一跳》。

2018年，微信小程序陆续更新升级功能，其中包括支持自定义小程序菜单栏等区域的页面风格、开放“附近小程序”、支持小程序投放广告、开发“功能直达”（微信 -- 附近的商家）、开发者工具支持真机调试等。

......

小程序迭代更新的两年多时间，无论从社区生态、技术架构、云端开发，还是开发者工具等方面来看，都有了质的飞跃，也让普通开发者能够快速上手，定制企业级或者属于个人的小程序。

### 小程序与公众号

微信公众号开发者需要懂得一门服务器端语言（如php、java、.net、nodejs）而对于前端开发人员来说，上手微信小程序开发没有任何门槛。
有关小程序前世今生的文案内容可以自行百度，不再赘述。

## 准备工作

小程序开发流程主要分为四步：
- 账号注册
- 信息完善
- 开发
- 提交审核与发布

### 申请账号

1. 在[微信公众平台](mp.weixin.qq.com)注册小程序账号，填写登记信息。图片: https://uploader.shimo.im/f/7B0Pe6yxw1wyUfGH.png

> 注：
> 1. 用于注册的邮箱账必须未被微信公众平台注册，未被微信开放平台注册、未被个人微信号绑定。
> 2. 每个邮箱只能申请一个小程序账号。

2. 注册后登陆微信公众平台，需要使用微信扫码验证身份后登陆。图片: https://uploader.shimo.im/f/yuzq9dX44s4gY1nK.png

> 注：登录的时候需要使用小程序身份的账号，这里区别于微信公众号身份的账号。

3. 完善小程序主体的相关设置信息。图片: https://uploader.shimo.im/f/UCtEgmTncRY7GrK1.png
每个小程序都拥有一个AppID，作为小程序的唯一标识。这个AppID可以用来在微信公众平台的其他身份账号中关联你已发布的微信小程序，或者在微信中搜索你的小程序。

4. 在提交审核与发布环节，需要为小程序配置页面功能。图片: https://uploader.shimo.im/f/Fw1D2pZs8poTLFmI.png图片: https://uploader.shimo.im/f/zj0bmvTDfzUH3klK.png

### 安装开发者工具

在[开发者工具](https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html?t=19041921)下载页面，选择下载版本。
图片: https://uploader.shimo.im/f/b71HNIfnBIMCZvoo.png

### 创建项目

开发者可以选择导入既有项目，也可以选择创建新项目。

创建新项目时，需要填入申请小程序账号时生成的AppID。如果没有AppID，也可以使用测试号体验小程序的开发，只不过这种模式下很多功能的使用将会受到限制，比如无法使用云服务。

开发者工具在近两年来不断的更新中，逐渐集成了一整套开发流程完备的架构，包括模拟器（界面）、编辑器（IDE）、调试器（控制台），同时支持版本控制、二维码编译、实时编译等，极大方便了开发者的开发体验。

初始化项目会生成一套项目配置文件，下面会逐一介绍各个模块配置文件的主要配置方式及作用。
图片: https://uploader.shimo.im/f/nfzxl52ExoIHBJZD.png

## 组件

小程序中原生组件的使用方式和html相似，也有着相似的属性。这里只列出原生组件的名称，相关使用方式、属性可以自行查阅开发者文档。

### 基础组件（native-component）
- 视图容器
1. cover-image             图片容器
2. cover-view
3. movable-area
4. movable-view
5. scroll-view
6. swiper                  滑块视图容器
7. swiper-item
8. view                    视图容器

- 基础内容
1. icon
2. progress
3. rich-text
4. text

- 表单组件
1. button
2. checkbox
3. checkbox-group
4. form
5. input
6. label
7. picker
8. picker-view
9. picker-view-column
10. radio
11. radio-group
12. slider
13. switch
14. textarea

- 导航
1. functional-page-navigator
2. navigator                    页面链接

- 媒体组件
1. audio
2. camera
3. image
4. live-player                  实时音视频播放
5. live-pusher                  实时音视频录制
6. video

- map地图API
1. map
2. canvas画布
3. canvas

- 其他
1. add                           Banner广告
2. open-data                     用于展示微信开放的数据
3. ......

### 自定义组件（custom-component）

我们也可以将页面内的功能模块抽象成自定义组件，以便在不同的页面中重复使用，或者将复杂的页面拆分成多个低耦合的模块，有助于代码维护。

这一点类似于 React 的组件化思想。其使用方法也和基础组件（即原生组件）非常相似。限于篇幅的原因，这里不多做描述，查看更多信息，请移步 自定义组件 。

## 架构
### 目录结构

以创建一个具备云开发功能的QuickStart项目为例：

小程序包含一个描述整体程序的 app 和多个描述各自页面的 page。

一个小程序的主体部分由三个文件组成，他们必须放置在项目根目录。

1. app.js
2. app.json
3. app.wxss

每个小程序页面模块有四个文件构成：

1. js
2. json
3. wxml
4. wxss

> 注意：为了减少开发者进行复杂冗余的配置项，描述页面模块的四个文件必须具有相同的路径与名称
图片: https://uploader.shimo.im/f/kVCCn9TdvXcQaOpV.png

### 代码构成

在上面创建的项目中，可以看到有以下几种类型的文件：
1. .json，**JSON配置文件**
   1. app.json是当前小程序的全局配置文件。主要配置小程序的所有页面路由、页面样式、底部Tab切换等。主要配置项有 pages、window、tabBar、sitemapLocation等字段，具体作用将结合代码讲解。
图片: https://uploader.shimo.im/f/ZtvNpG3eUBILTfan.png

   2. project.config.json是开发者工具的个性化配置。开发者可以针对自己的喜好对开发工具做一些界面样式、编译等的配置。

   3. 页面组件中的page.json，作用和 app.json 类似。app.json用来配置小程序全局的一些样式风格色调，但当开发者想要在某模块页面中设置自定义风格时，就可以通过 page.json 配置该模块页面的一些属性，用以覆盖改写全局配置属性。

2. .wxml，WXML模板文件
    作用、语法类同于HTML，但原生标签不同于HTML。微信小程序有自己专属的原生标签、标签属性以及js表达式语法，后面的章节将会详细介绍。

3. .wxss，WXSS样式文件
同css样式文件。但小程序新增了尺寸单位 rpx。开发者不在需要针对手机设备屏幕的不同宽度做一些复杂换算，这些工作将交由小程序底层来做。
wxss有全局样式和局部样式的概念，其用法和上面讲到的 app.json / page.json 的区别与用法相同。

4. .js，JS脚本文件
开发者还可以利用小程序提供的丰富的API，开发一些常用的业务场景，如获取用户信息、本地存储、微信支付、生成小程序吗、扫描二维码等等。
图片: https://uploader.shimo.im/f/NncRKZ8KIcwRa3fh.png

### 配置文件

- 全局配置
  app.json，以小程序示例项目代码为例：
```json
{
  "pages": [
    "page/component/index",
    "page/component/pages/view/view",
    "page/cloud/pages/scf-storage/scf-storage",
  ],
  "window": {
    "navigationBarTextStyle": "black",
    "navigationBarTitleText": "演示",
    "navigationBarBackgroundColor": "#F8F8F8",
    "backgroundColor": "#F8F8F8"
  },
  "tabBar": {
    "color": "#7A7E83",
    "selectedColor": "#3cc51f",
    "borderStyle": "black",
    "backgroundColor": "#ffffff",
    "list": [
      {
        "pagePath": "page/component/index",
        "iconPath": "image/icon_component.png",
        "selectedIconPath": "image/icon_component_HL.png",
        "text": "组件"
      },
      {
        "pagePath": "page/API/index",
        "iconPath": "image/icon_API.png",
        "selectedIconPath": "image/icon_API_HL.png",
        "text": "接口"
      },
      {
        "pagePath": "page/cloud/index",
        "iconPath": "image/icon_cloud.png",
        "selectedIconPath": "image/icon_cloud_HL.png",
        "text": "云开发"
      }
    ]
  },
  "networkTimeout": {
    "request": 10000,
    "uploadFile": 10000,
    "downloadFile": 10000
  },
  "cloud": true,
  "sitemapLocation": "sitemap.json"
}
```

- 页面配置
  page/index/index.json，页面模块配置项：

```json
// /page/index页面的json配置项（json中不支持注释）
{
  "navigationBarTitleText": "小程序官方组件展示",
  "navigationBarBackgroundColor": "#ffffff",
  "navigationBarTextStyle": "black",
  "backgroundColor": "#eeeeee",
  "backgroundTextStyle": "light"
}
```

- sitemap配置
  跟目录下的 sitemap.json 文件用来配置小程序及其页面是否允许在微信内被索引。
```json
{
  "desc": "some description info...",
  "rules": [{
      "action": "allow",
    "page": "*"          // 表示所有页面都可以被索引
  }]
}
```

### 运行机制（逻辑层）

小程序在原有JavaScript的基础上扩展了部分功能，以方便小程序的开发：
1. 增加 App 和 Page 方法，进行小程序注册和页面注册。
2. 增加 getApp 和 getCurrentPages 方法，分别用来获取 App 实例和当前页面栈。
3. 增加API。
4. 支持模块化。

> 注意：小程序框架的逻辑层并非运行在浏览器中，所以js在浏览器端的一些特性将无法使用，如 window、document等。

- 注册小程序

每一个小程序都需要在全局 app.js 中调用 App 方法注册小程序实例，并绑定生命周期回调函数、错误监听和页面不存在监听函数等。

App 方法只能在 app.js 中调用有且仅有一次，这个实例是全部页面共享的。开发者可以在页面模块中**通过 getApp 方法获取到全局唯一的这个实例**，并去调用在实例上注册或声明的函数或变量。

参数是一个 Object 对象。
```javascript
// App()
App({
  onLaunch(options) {
    // Do something initial when launch.
  },
  onShow(options) {
    // Do something when show.
  },
  onHide() {
    // Do something when hide.
  },
  onError(msg) {
    console.log(msg)
  },
  globalData: 'some datas',        // 用于自定义的变量或函数
})
```
```javascript
// getApp()
// page/index/index.js
const appInstance = getApp();
console.log(appInstance.globalData);    // some datas
```

- 注册页面

每个页面模块都需要在对应的 js文件中调用 Page 方法注册页面实例，指定页面初始化数据、生命周期回调、事件处理函数等。
```javascript
Page({
  data: {
    text: 'This is page data.'
  },
  onLoad(options) {
    // Do some initialize when page load.
  },
  onReady() {
    // Do something when page ready.
  },
  onShow() {
    // Do something when page show.
  },
  onHide() {
    // Do something when page hide.
  },
  onUnload() {
    // Do something when page close.
  },
  onPullDownRefresh() {
    // Do something when pull down.
  },
  onPageScroll() {
    // Do something when page scroll
  },
  onResize() {
    // Do something when page resize
  },
  onTabItemTap(item) {
    console.log(item.index)
    console.log(item.pagePath)
    console.log(item.text)
  },
})
```

- 小程序生命周期
  见上例代码部分。

- 页面路由
  小程序的路由跳转方式一般包括：初始化、重定向、返回、Tab切换、重启动。我们可以直接参考开发者文档对页面路由触发方式的定义：

  路由跳转的实例方法参见：
  小程序示例项目代码 /page/pages/navigator/navigator.js 。
  图片: https://uploader.shimo.im/f/Ls2rwgvrx5sCJ87P.png

### WXML语法（视图层）

- 数据绑定
数据绑定使用 Mustache 语法。WXML中的动态数据全部来自于对应 Page 方法中定义的 data。
```javascript
// xxx.js
Page({
  data: {
    id: 'my_mini_program',
    condition: '',
    message: 'Hello MINA!'
  }
})
```

除了内容渲染外、组件属性、控制属性、关键字都需要使用双引号。
```jsx
// 组件属性
<view id="item-{{id}}"></view>

// 控制属性
<view wx:if="{{condition}}"></view>

// 关键字
<checkbox checked="{{false}}"></checkbox>
```

- 列表渲染

  **wx:for**

  在组件上使用 wx:for 控制属性绑定一个数组，就可以直接使用数组中各项的数据重复渲染该组件。默认数组的当前想的下标变量名默认为 index，数组当前项的变量名默认为 item。
  ```jsx
  <view wx:for="{{array}}" wx:for-index="idx" ewx:for-item="itemName">
  // {{index}}: {{item.message}}
  {{idx}}: {{itemName.message}}}
  </view>
  ```

  **block wx:for**
  类似 block wx:if，也可以将 wx:for 用在<block/>标签上，以渲染一个包含多节点的结构块。例如：
  ```jsx
  <block wx:for="{{[1, 2, 3]}}">
    <view>{{index}}:</view>
    <view>{{item}}</view>
  </block>
  ```

  **wx:key**
  同React 中 key 值的概念，小程序中需要使用 wx:key 来指定动态变化的列表渲染数据中item的唯一标识符。

  wx:key 的值以两种形式提供
  1. 字符串，代表在 for 循环的 array 中 item 的某个 property，该 property 的值需要是列表中唯一的字符串或数字，且不能动态改变。

  2. 保留关键字 *this 代表在 for 循环中的 item 本身，这种表示需要 item 本身是一个唯一的字符串或者数字

  > 注：如不提供 wx:key，会报一个 warning， 如果明确知道该列表是静态，或者不必关注其顺序，可以选择忽略。

- 条件渲染

  **wx:if**
  小程序框架中，可以使用 wx:if="{{condition}}" 来判断是否渲染该代码块。
  ```jsx
  <view wx:if="{{condition}}">Contents</view>
  ```

  也可以使用 wx:elif 和 wx:else 来添加一个 else 块。
  ```jsx
  <view wx:if="{{length > 5}}">1</view>
  <view wx:elif="{{length > 2}}">2</view>
  <view wx:else>3</view>
  ```

  **block wx:if**

  当控制属性 wx:if 一次性需要判断多个组件标签时，可以使用 <block /> 标签将多个组件报过起来，并在其上使用控制属性 wx:if。但  <block /> 并不是一个组件，只作为一个包裹元素，类似于 React 中的 Fragment。
  ```jsx
  <block wx:if="{{true}}">
    <view>{{ view }}</view>
    <view>view2</view>
  </block>
  ```

- 模板

  WXML提供了模板（template）的概念，开发者可以在模板中定义代码片段，在其他不同模块中调用。

  定义一个模板。使用 name 属性作为模板的名称，然后在这个模板内定义代码片段：
  ```jsx
  <template name="msgItem">
    <view>
      <text>...</text>
    </view>
  </template>
  ```

  使用模板。使用 is 属性，声明需要使用的模板，然后将模板所需数据传入到属性中即可。
  ```jsx
  <template is="msgItem" data="{{...item}}" />
  ```

  开发者也可以使用 is 属性的 Mustache 语法，动态决定具体需要渲染哪些模板内容（即在 is 中做逻辑判断）。同时，模板中只能使用 data 传进来的数据。

  很多时候，模板用来抽取小程序页面页头和页脚的通用组件。

  <br>
- 引用
  WXML提供了两种文件引用方式 import 和 include。

  **import**

  那么上面定义了模板文件，该如何将文件引入到目标组件中呢？可以使用 import 方式。

  比如上述模板 msgItem 是在 item.wxml 中定义的，那么我们如果想要在 index.wxml 文件中引入，只需要这样做：

  ```javascript
  // index.wxml
  <import src="item.wxml">
  <template is="msgItem" data="{{...item}}" />
  ```

  **include**
可以简单的将 include 的作用理解成拷贝一份文件到当前位置，但所拷贝的目标文件中的 <template /> 和 <wxs /> 不会被引入。
例如：
// header.wxml
<view>header infos</view>

// footer.wxml
<view>footer infos</view>

// index.wxml
<include src="header.wxml" />
<view>body infos</view>
<include src="footer.wxml" />

API与云开发
小程序API与服务端API
小程序开发框架提供了丰富的微信原生API，可以方便地调用微信提供的能力。如获取用户信息、本地存储、扫码支付等。
小程序API有以下类型：
事件监听API
同步API
异步API
参阅 API 与 服务端API，查看小程序的开放接口的具体使用方法。
云开发
通过开发者工具创建具有云开发功能的QuickStart项目，点击工具栏云开发按钮开通云开发功能。
图片: https://uploader.shimo.im/f/VGpLQS9JHIgj66aI.png
创建云开发环境。
图片: https://uploader.shimo.im/f/7zJ3dkdep2kfPMJc.png
图片: https://uploader.shimo.im/f/F8pZyDpM1Wkr1kLg.png
在云开发控制台中使用数据库、存储、云函数功能，查看小程序云端开发运营分析数据。
图片: https://uploader.shimo.im/f/gpveYbiJAego1Ut8.png


小程序示例源码分析

参见源码。
参考站点
微信公众平台 - 小程序开发
小程序社区
2019年微信公开课PRO
微信开放社区 - Taro团队携手云开发搭建电商后台服务
知乎：如何入门微信小程序开发，有哪些学习资料？




